# This will be sourced before launching a Singularity container.
# Any variables prefixed with "SINGULARITYENV_" will be transposed
# properly into the container. For example:
# SINGULARITYENV_LD_LIBRARY_PATH -> LD_LIBRARY_PATH

# Environment modules if set, cause errors in containers
unset module
unset ml

# Bash env has been known to cause issues in containers
unset BASH_ENV

# Provide a sane path within the container
if [ -z ${SINGULARITYENV_PATH+x} ]; then
    SINGULARITYENV_PATH="/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"
else
    SINGULARITYENV_PATH="$SINGULARITYENV_PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"
fi

# Don't save the shell's HISTFILE
SINGULARITYENV_HISTFILE=""

export SINGULARITYENV_PATH SINGULARITYENV_HISTFILE

# For Infiniband setting on AAIC
SINGULARITY_IBLIBLIST=`mktemp ${TMPDIR:-/tmp}/.singularity-ibliblist.XXXXXXXX`
cat $SINGULARITY_sysconfdir"/singularity/ibliblist.conf" | grep -Ev "^#|^\s*$" > $SINGULARITY_IBLIBLIST
for i in $(ldconfig -p | grep -f "${SINGULARITY_IBLIBLIST}"); do
    if [ -f "$i" ]; then
	message 2 "Found IB library: $i\n"
        if [ -z "${SINGULARITY_CONTAINLIBS:-}" ]; then
            SINGULARITY_CONTAINLIBS="$i"
        else
            SINGULARITY_CONTAINLIBS="$SINGULARITY_CONTAINLIBS,$i"
        fi
    fi
done
## FIXME for manual setting
SINGULARITY_CONTAINLIBS="$SINGULARITY_CONTAINLIBS,/lib64/libmlx5-rdmav2.so"
rm $SINGULARITY_IBLIBLIST
if [ -z "${SINGULARITY_CONTAINLIBS:-}" ]; then
    message WARN "Could not find any IB-related libraries on this host!\n"; 
else
    export SINGULARITY_CONTAINLIBS
fi
